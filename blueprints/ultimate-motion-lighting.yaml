blueprint:
  name: Advanced Time + Motion-Based Lighting Control
  description: >
    When motion is detected, turn on different lights/brightness/RGB, scenes, or switches
    depending on the current time period, then turn them off after a configurable
    no-motion delay for that period. Each period can independently use lights, scenes,
    or switches. One automation can cover a whole day's behavior.
  domain: automation
  input:
    motion_sensors:
      name: Motion sensors
      description: One or more motion sensors that will trigger this automation.
      selector:
        entity:
          domain: binary_sensor
          device_class: motion
          multiple: true

    off_lights:
      name: Lights to turn off (optional)
      description: >
        Lights that should be turned off after the no-motion delay. This should
        include any lights that might be turned on by this automation (whether
        via direct control or via scenes).
      default: {}
      selector:
        target:
          entity:
            domain: light

    off_switches:
      name: Switches to turn off (optional)
      description: >
        Switches that should be turned off after the no-motion delay.
      default: {}
      selector:
        target:
          entity:
            domain: switch

    # -------- TIME PERIOD 1 --------
    period1_start:
      name: Period 1 start time
      selector:
        time:
    period1_end:
      name: Period 1 end time
      selector:
        time:
    period1_off_delay:
      name: Period 1 off delay
      description: How long after last motion to turn the lights off in period 1.
      default:
        hours: 0
        minutes: 5
        seconds: 0
      selector:
        duration:

    period1_control_mode:
      name: Period 1 control mode
      description: Choose whether period 1 uses lights, scenes, or switches.
      default: lights
      selector:
        select:
          options:
            - lights
            - scenes
            - switches

    period1_lights:
      name: Period 1 lights (optional)
      description: Lights to control during period 1 (used when control mode = lights).
      default: {}
      selector:
        target:
          entity:
            domain: light
    period1_brightness:
      name: Period 1 brightness
      description: Brightness in percent for all selected lights in period 1.
      default: 20
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
          mode: slider
    period1_color:
      name: Period 1 RGB color
      description: RGB color for all selected lights in period 1.
      default: [255, 255, 255]
      selector:
        color_rgb:

    period1_scene:
      name: Period 1 scene (optional)
      description: Scene to activate in period 1 (used when control mode = scenes).
      default: ""
      selector:
        entity:
          domain: scene

    period1_switches:
      name: Period 1 switches (optional)
      description: Switches to control during period 1 (used when control mode = switches).
      default: {}
      selector:
        target:
          entity:
            domain: switch

    # -------- TIME PERIOD 2 --------
    period2_start:
      name: Period 2 start time
      selector:
        time:
    period2_end:
      name: Period 2 end time
      selector:
        time:
    period2_off_delay:
      name: Period 2 off delay
      description: How long after last motion to turn the lights off in period 2.
      default:
        hours: 0
        minutes: 5
        seconds: 0
      selector:
        duration:

    period2_control_mode:
      name: Period 2 control mode
      description: Choose whether period 2 uses lights, scenes, or switches.
      default: lights
      selector:
        select:
          options:
            - lights
            - scenes
            - switches

    period2_lights:
      name: Period 2 lights (optional)
      description: Lights to control during period 2 (used when control mode = lights).
      default: {}
      selector:
        target:
          entity:
            domain: light
    period2_brightness:
      name: Period 2 brightness
      description: Brightness in percent for all selected lights in period 2.
      default: 40
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
          mode: slider
    period2_color:
      name: Period 2 RGB color
      description: RGB color for all selected lights in period 2.
      default: [255, 0, 0]
      selector:
        color_rgb:

    period2_scene:
      name: Period 2 scene (optional)
      description: Scene to activate in period 2 (used when control mode = scenes).
      default: ""
      selector:
        entity:
          domain: scene

    period2_switches:
      name: Period 2 switches (optional)
      description: Switches to control during period 2 (used when control mode = switches).
      default: {}
      selector:
        target:
          entity:
            domain: switch

    # -------- TIME PERIOD 3 --------
    period3_start:
      name: Period 3 start time
      selector:
        time:
    period3_end:
      name: Period 3 end time
      selector:
        time:
    period3_off_delay:
      name: Period 3 off delay
      description: How long after last motion to turn the lights off in period 3.
      default:
        hours: 0
        minutes: 10
        seconds: 0
      selector:
        duration:

    period3_control_mode:
      name: Period 3 control mode
      description: Choose whether period 3 uses lights, scenes, or switches.
      default: lights
      selector:
        select:
          options:
            - lights
            - scenes
            - switches

    period3_lights:
      name: Period 3 lights (optional)
      description: Lights to control during period 3 (used when control mode = lights).
      default: {}
      selector:
        target:
          entity:
            domain: light
    period3_brightness:
      name: Period 3 brightness
      description: Brightness in percent for all selected lights in period 3.
      default: 20
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
          mode: slider
    period3_color:
      name: Period 3 RGB color
      description: RGB color for all selected lights in period 3.
      default: [255, 0, 0]
      selector:
        color_rgb:

    period3_scene:
      name: Period 3 scene (optional)
      description: Scene to activate in period 3 (used when control mode = scenes).
      default: ""
      selector:
        entity:
          domain: scene

    period3_switches:
      name: Period 3 switches (optional)
      description: Switches to control during period 3 (used when control mode = switches).
      default: {}
      selector:
        target:
          entity:
            domain: switch

    # -------- TIME PERIOD 4 --------
    period4_start:
      name: Period 4 start time
      selector:
        time:
    period4_end:
      name: Period 4 end time
      selector:
        time:
    period4_off_delay:
      name: Period 4 off delay
      description: How long after last motion to turn the lights off in period 4.
      default:
        hours: 0
        minutes: 5
        seconds: 0
      selector:
        duration:

    period4_control_mode:
      name: Period 4 control mode
      description: Choose whether period 4 uses lights, scenes, or switches.
      default: lights
      selector:
        select:
          options:
            - lights
            - scenes
            - switches

    period4_lights:
      name: Period 4 lights (optional)
      description: Lights to control during period 4 (used when control mode = lights).
      default: {}
      selector:
        target:
          entity:
            domain: light
    period4_brightness:
      name: Period 4 brightness
      description: Brightness in percent for all selected lights in period 4.
      default: 10
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
          mode: slider
    period4_color:
      name: Period 4 RGB color
      description: RGB color for all selected lights in period 4.
      default: [255, 0, 0]
      selector:
        color_rgb:

    period4_scene:
      name: Period 4 scene (optional)
      description: Scene to activate in period 4 (used when control mode = scenes).
      default: ""
      selector:
        entity:
          domain: scene

    period4_switches:
      name: Period 4 switches (optional)
      description: Switches to control during period 4 (used when control mode = switches).
      default: {}
      selector:
        target:
          entity:
            domain: switch

    # -------- TIME PERIOD 5 --------
    period5_start:
      name: Period 5 start time
      selector:
        time:
    period5_end:
      name: Period 5 end time
      selector:
        time:
    period5_off_delay:
      name: Period 5 off delay
      description: How long after last motion to turn the lights off in period 5.
      default:
        hours: 0
        minutes: 5
        seconds: 0
      selector:
        duration:

    period5_control_mode:
      name: Period 5 control mode
      description: Choose whether period 5 uses lights, scenes, or switches.
      default: lights
      selector:
        select:
          options:
            - lights
            - scenes
            - switches

    period5_lights:
      name: Period 5 lights (optional)
      description: Lights to control during period 5 (used when control mode = lights).
      default: {}
      selector:
        target:
          entity:
            domain: light
    period5_brightness:
      name: Period 5 brightness
      description: Brightness in percent for all selected lights in period 5.
      default: 50
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
          mode: slider
    period5_color:
      name: Period 5 RGB color
      description: RGB color for all selected lights in period 5.
      default: [255, 255, 255]
      selector:
        color_rgb:

    period5_scene:
      name: Period 5 scene (optional)
      description: Scene to activate in period 5 (used when control mode = scenes).
      default: ""
      selector:
        entity:
          domain: scene

    period5_switches:
      name: Period 5 switches (optional)
      description: Switches to control during period 5 (used when control mode = switches).
      default: {}
      selector:
        target:
          entity:
            domain: switch

    # -------- TIME PERIOD 6 --------
    period6_start:
      name: Period 6 start time
      selector:
        time:
    period6_end:
      name: Period 6 end time
      selector:
        time:
    period6_off_delay:
      name: Period 6 off delay
      description: How long after last motion to turn the lights off in period 6.
      default:
        hours: 0
        minutes: 5
        seconds: 0
      selector:
        duration:

    period6_control_mode:
      name: Period 6 control mode
      description: Choose whether period 6 uses lights, scenes, or switches.
      default: lights
      selector:
        select:
          options:
            - lights
            - scenes
            - switches

    period6_lights:
      name: Period 6 lights (optional)
      description: Lights to control during period 6 (used when control mode = lights).
      default: {}
      selector:
        target:
          entity:
            domain: light
    period6_brightness:
      name: Period 6 brightness
      description: Brightness in percent for all selected lights in period 6.
      default: 75
      selector:
        number:
          min: 1
          max: 100
          unit_of_measurement: "%"
          mode: slider
    period6_color:
      name: Period 6 RGB color
      description: RGB color for all selected lights in period 6.
      default: [255, 255, 255]
      selector:
        color_rgb:

    period6_scene:
      name: Period 6 scene (optional)
      description: Scene to activate in period 6 (used when control mode = scenes).
      default: ""
      selector:
        entity:
          domain: scene

    period6_switches:
      name: Period 6 switches (optional)
      description: Switches to control during period 6 (used when control mode = switches).
      default: {}
      selector:
        target:
          entity:
            domain: switch

mode: restart
max_exceeded: silent

variables:
  period1_start: !input period1_start
  period1_end: !input period1_end
  period1_control_mode: !input period1_control_mode
  period2_start: !input period2_start
  period2_end: !input period2_end
  period2_control_mode: !input period2_control_mode
  period3_start: !input period3_start
  period3_end: !input period3_end
  period3_control_mode: !input period3_control_mode
  period4_start: !input period4_start
  period4_end: !input period4_end
  period4_control_mode: !input period4_control_mode
  period5_start: !input period5_start
  period5_end: !input period5_end
  period5_control_mode: !input period5_control_mode
  period6_start: !input period6_start
  period6_end: !input period6_end
  period6_control_mode: !input period6_control_mode

trigger:
  - platform: state
    entity_id: !input motion_sensors
    to: "on"

action:
  - choose:
      # ---------- PERIOD 1 ----------
      - conditions:
          - condition: template
            value_template: >
              {% set now_time = now().strftime('%H:%M:%S') %}
              {% set start = period1_start %}
              {% set end = period1_end %}
              {% if start <= end %}
                {{ start <= now_time < end }}
              {% else %}
                {{ now_time >= start or now_time < end }}
              {% endif %}
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ period1_control_mode == 'lights' }}"
                sequence:
                  - service: light.turn_on
                    target: !input period1_lights
                    data:
                      brightness_pct: !input period1_brightness
                      rgb_color: !input period1_color
              - conditions:
                  - condition: template
                    value_template: "{{ period1_control_mode == 'scenes' }}"
                sequence:
                  - service: scene.turn_on
                    target:
                      entity_id: !input period1_scene
              - conditions:
                  - condition: template
                    value_template: "{{ period1_control_mode == 'switches' }}"
                sequence:
                  - service: switch.turn_on
                    target: !input period1_switches

          - wait_for_trigger:
              - platform: state
                entity_id: !input motion_sensors
                to: "off"
                for: !input period1_off_delay

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ period1_control_mode == 'switches' }}"
                sequence:
                  - service: switch.turn_off
                    target: !input off_switches
            default:
              - service: light.turn_off
                target: !input off_lights

      # ---------- PERIOD 2 ----------
      - conditions:
          - condition: template
            value_template: >
              {% set now_time = now().strftime('%H:%M:%S') %}
              {% set start = period2_start %}
              {% set end = period2_end %}
              {% if start <= end %}
                {{ start <= now_time < end }}
              {% else %}
                {{ now_time >= start or now_time < end }}
              {% endif %}
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ period2_control_mode == 'lights' }}"
                sequence:
                  - service: light.turn_on
                    target: !input period2_lights
                    data:
                      brightness_pct: !input period2_brightness
                      rgb_color: !input period2_color
              - conditions:
                  - condition: template
                    value_template: "{{ period2_control_mode == 'scenes' }}"
                sequence:
                  - service: scene.turn_on
                    target:
                      entity_id: !input period2_scene
              - conditions:
                  - condition: template
                    value_template: "{{ period2_control_mode == 'switches' }}"
                sequence:
                  - service: switch.turn_on
                    target: !input period2_switches

          - wait_for_trigger:
              - platform: state
                entity_id: !input motion_sensors
                to: "off"
                for: !input period2_off_delay

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ period2_control_mode == 'switches' }}"
                sequence:
                  - service: switch.turn_off
                    target: !input off_switches
            default:
              - service: light.turn_off
                target: !input off_lights

      # ---------- PERIOD 3 ----------
      - conditions:
          - condition: template
            value_template: >
              {% set now_time = now().strftime('%H:%M:%S') %}
              {% set start = period3_start %}
              {% set end = period3_end %}
              {% if start <= end %}
                {{ start <= now_time < end }}
              {% else %}
                {{ now_time >= start or now_time < end }}
              {% endif %}
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ period3_control_mode == 'lights' }}"
                sequence:
                  - service: light.turn_on
                    target: !input period3_lights
                    data:
                      brightness_pct: !input period3_brightness
                      rgb_color: !input period3_color
              - conditions:
                  - condition: template
                    value_template: "{{ period3_control_mode == 'scenes' }}"
                sequence:
                  - service: scene.turn_on
                    target:
                      entity_id: !input period3_scene
              - conditions:
                  - condition: template
                    value_template: "{{ period3_control_mode == 'switches' }}"
                sequence:
                  - service: switch.turn_on
                    target: !input period3_switches

          - wait_for_trigger:
              - platform: state
                entity_id: !input motion_sensors
                to: "off"
                for: !input period3_off_delay

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ period3_control_mode == 'switches' }}"
                sequence:
                  - service: switch.turn_off
                    target: !input off_switches
            default:
              - service: light.turn_off
                target: !input off_lights

      # ---------- PERIOD 4 ----------
      - conditions:
          - condition: template
            value_template: >
              {% set now_time = now().strftime('%H:%M:%S') %}
              {% set start = period4_start %}
              {% set end = period4_end %}
              {% if start <= end %}
                {{ start <= now_time < end }}
              {% else %}
                {{ now_time >= start or now_time < end }}
              {% endif %}
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ period4_control_mode == 'lights' }}"
                sequence:
                  - service: light.turn_on
                    target: !input period4_lights
                    data:
                      brightness_pct: !input period4_brightness
                      rgb_color: !input period4_color
              - conditions:
                  - condition: template
                    value_template: "{{ period4_control_mode == 'scenes' }}"
                sequence:
                  - service: scene.turn_on
                    target:
                      entity_id: !input period4_scene
              - conditions:
                  - condition: template
                    value_template: "{{ period4_control_mode == 'switches' }}"
                sequence:
                  - service: switch.turn_on
                    target: !input period4_switches

          - wait_for_trigger:
              - platform: state
                entity_id: !input motion_sensors
                to: "off"
                for: !input period4_off_delay

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ period4_control_mode == 'switches' }}"
                sequence:
                  - service: switch.turn_off
                    target: !input off_switches
            default:
              - service: light.turn_off
                target: !input off_lights

      # ---------- PERIOD 5 ----------
      - conditions:
          - condition: template
            value_template: >
              {% set now_time = now().strftime('%H:%M:%S') %}
              {% set start = period5_start %}
              {% set end = period5_end %}
              {% if start <= end %}
                {{ start <= now_time < end }}
              {% else %}
                {{ now_time >= start or now_time < end }}
              {% endif %}
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ period5_control_mode == 'lights' }}"
                sequence:
                  - service: light.turn_on
                    target: !input period5_lights
                    data:
                      brightness_pct: !input period5_brightness
                      rgb_color: !input period5_color
              - conditions:
                  - condition: template
                    value_template: "{{ period5_control_mode == 'scenes' }}"
                sequence:
                  - service: scene.turn_on
                    target:
                      entity_id: !input period5_scene
              - conditions:
                  - condition: template
                    value_template: "{{ period5_control_mode == 'switches' }}"
                sequence:
                  - service: switch.turn_on
                    target: !input period5_switches

          - wait_for_trigger:
              - platform: state
                entity_id: !input motion_sensors
                to: "off"
                for: !input period5_off_delay

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ period5_control_mode == 'switches' }}"
                sequence:
                  - service: switch.turn_off
                    target: !input off_switches
            default:
              - service: light.turn_off
                target: !input off_lights

      # ---------- PERIOD 6 ----------
      - conditions:
          - condition: template
            value_template: >
              {% set now_time = now().strftime('%H:%M:%S') %}
              {% set start = period6_start %}
              {% set end = period6_end %}
              {% if start <= end %}
                {{ start <= now_time < end }}
              {% else %}
                {{ now_time >= start or now_time < end }}
              {% endif %}
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ period6_control_mode == 'lights' }}"
                sequence:
                  - service: light.turn_on
                    target: !input period6_lights
                    data:
                      brightness_pct: !input period6_brightness
                      rgb_color: !input period6_color
              - conditions:
                  - condition: template
                    value_template: "{{ period6_control_mode == 'scenes' }}"
                sequence:
                  - service: scene.turn_on
                    target:
                      entity_id: !input period6_scene
              - conditions:
                  - condition: template
                    value_template: "{{ period6_control_mode == 'switches' }}"
                sequence:
                  - service: switch.turn_on
                    target: !input period6_switches

          - wait_for_trigger:
              - platform: state
                entity_id: !input motion_sensors
                to: "off"
                for: !input period6_off_delay

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ period6_control_mode == 'switches' }}"
                sequence:
                  - service: switch.turn_off
                    target: !input off_switches
            default:
              - service: light.turn_off
                target: !input off_lights
